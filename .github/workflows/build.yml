name: Build Modules
on:
  workflow_call:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Fixed from 'write-all' to 'write'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
      - name: Update config
        run: |
          if git checkout origin/update build.md 2>/dev/null; then
            if [ -f "./build.sh" ] && [ -f "config.toml" ]; then
              UPDATE_CFG=$(./build.sh config.toml --config-update 2>/dev/null || echo "")
              if [ -n "$UPDATE_CFG" ]; then
                echo "$UPDATE_CFG" > config.json
              fi
            fi
          fi
      - name: Get next version
        id: version
        run: |
          LATEST_TAG=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest" | grep -o '"tag_name": "[^"]*' | cut -d'"' -f4 || echo "0")
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            LATEST_TAG="0"
          fi
          NEXT_VERSION=$((LATEST_TAG + 1))
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next version will be: $NEXT_VERSION"
      - name: Build modules and APKs
        run: |
          if [ -f "config.json" ]; then
            ./build.sh config.json
          elif [ -f "config.toml" ]; then
            ./build.sh config.toml
          else
            echo "No config file found!"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          NEXT_VER_CODE: ${{ steps.version.outputs.NEXT_VERSION }}
      - name: Prepare build output
        id: build_info
        run: |
          if [ ! -d "build" ]; then
            echo "Build directory not found!"
            exit 1
          fi
          cd build
          FILES=$(ls -1 | grep '\.apk$' | tr '\n' ',' | sed 's/,$//')
          COUNT=$(ls -1 | grep '\.apk$' | wc -l)
          echo "BUILD_COUNT=$COUNT" >> $GITHUB_OUTPUT
          echo "BUILD_FILES=$FILES" >> $GITHUB_OUTPUT
          if [ -f "../build.md" ]; then
            cp ../build.md changelog.md
          else
            echo "Automated build $(date)" > changelog.md
          fi
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.NEXT_VERSION }}
          name: ReX ${{ steps.version.outputs.NEXT_VERSION }}
          body_path: build/changelog.md
          files: build/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Send Telegram Message with Attachments
        if: always()
        run: |
          # Check if build directory exists
          if [ ! -d "build" ]; then
            echo "Build directory not found!"
            # Send failure message
            STATUS="‚ùå FAILED - Build directory not found"
            DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
            MSG="<b>üö´ ReVanced Build Failed</b>%0A<b>Status:</b> ${STATUS}%0A<b>Build:</b> ${{ steps.version.outputs.NEXT_VERSION }}%0A<b>Time:</b> ${DATE}"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
              -d chat_id=717601421 \
              -d text="$MSG" \
              -d parse_mode=HTML
            exit 0
          fi
          
          # Check if APK files exist in build directory
          if ! ls build/*.apk >/dev/null 2>&1; then
            echo "No APK files found in build directory"
            # Send failure message
            STATUS="‚ùå FAILED - No APK files found"
            DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
            MSG="<b>üö´ ReVanced Build Failed</b>%0A<b>Status:</b> ${STATUS}%0A<b>Build:</b> ${{ steps.version.outputs.NEXT_VERSION }}%0A<b>Time:</b> ${DATE}"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
              -d chat_id=717601421 \
              -d text="$MSG" \
              -d parse_mode=HTML
            exit 0
          fi
          
          # Get file info
          cd build
          FILES=$(ls -1 *.apk 2>/dev/null)
          FILE_COUNT=$(echo "$FILES" | wc -l)
          STATUS="‚úÖ SUCCESS"
          DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          
          echo "Found $FILE_COUNT APK files to send"
          
          # Send first file with full message, rest with just filename
          FIRST_FILE=true
          for FILE in $FILES; do
            # Check if file actually exists and is readable
            if [ ! -f "$FILE" ]; then
              echo "‚ö†Ô∏è File $FILE not found, skipping..."
              continue
            fi
            
            FILE_SIZE=$(stat -c%s "$FILE" 2>/dev/null || echo "0")
            if [ "$FILE_SIZE" -eq 0 ]; then
              echo "‚ö†Ô∏è File $FILE is empty, skipping..."
              continue
            fi
            
            if [ "$FIRST_FILE" = true ]; then
              MSG="<b>üéâ ReVanced Build Complete</b>%0A<b>Status:</b> ${STATUS}%0A<b>Build:</b> ${{ steps.version.outputs.NEXT_VERSION }}%0A<b>Files:</b> ${FILE_COUNT}%0A<b>Time:</b> ${DATE}%0A%0Aüì± <code>${FILE}</code>"
              FIRST_FILE=false
            else
              MSG="üì± <code>${FILE}</code>"
            fi
            
            echo "Sending $FILE to Telegram (Size: ${FILE_SIZE} bytes)..."
            
            # Use timeout to prevent hanging
            RESPONSE=$(timeout 60 curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument" \
              -F chat_id=717601421 \
              -F caption="$MSG" \
              -F parse_mode=HTML \
              -F document=@"$FILE" 2>&1)
            
            CURL_EXIT_CODE=$?
            
            # Check if send was successful
            if [ $CURL_EXIT_CODE -eq 0 ] && echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "‚úÖ Successfully sent $FILE"
            else
              echo "‚ùå Failed to send $FILE (Exit code: $CURL_EXIT_CODE)"
              echo "Response: $RESPONSE"
              
              # Try sending error notification
              ERROR_MSG="<b>‚ö†Ô∏è File Upload Failed</b>%0A<b>File:</b> <code>${FILE}</code>%0A<b>Error:</b> Upload failed"
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
                -d chat_id=717601421 \
                -d text="$ERROR_MSG" \
                -d parse_mode=HTML
            fi
            
            # Small delay between sends to avoid rate limiting
            sleep 3
          done
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
