name: CI

on:
  workflow_dispatch:
  schedule:
    - cron: "0 16 * * *"

jobs:
  check:
    runs-on: ubuntu-latest
    permissions: write-all
    outputs:
      SHOULD_BUILD: ${{ steps.should_build.outputs.SHOULD_BUILD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest ReVanced pre-release tag
        id: latest_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          latest_tag=$(gh api repos/anddea/revanced-patches/releases --jq 'map(select(.prerelease)) | first.tag_name')
          echo "Latest pre-release tag: $latest_tag"
          echo "LATEST_TAG=$latest_tag" >> $GITHUB_OUTPUT

      - name: Should build?
        id: should_build
        shell: bash
        run: |
          TAG_FILE=".github/last_revanced_tag.txt"
          
          # First time or tag changed
          if [ ! -f "$TAG_FILE" ]; then
            echo "First time build. Saving tag."
            echo "${{ steps.latest_release.outputs.LATEST_TAG }}" > "$TAG_FILE"
            echo "SHOULD_BUILD=1" >> $GITHUB_OUTPUT
          else
            prev_tag=$(cat "$TAG_FILE")
            if [ "$prev_tag" != "${{ steps.latest_release.outputs.LATEST_TAG }}" ]; then
              echo "Tag changed: $prev_tag â†’ ${{ steps.latest_release.outputs.LATEST_TAG }}"
              echo "${{ steps.latest_release.outputs.LATEST_TAG }}" > "$TAG_FILE"
              echo "SHOULD_BUILD=1" >> $GITHUB_OUTPUT
            else
              echo "No new pre-release. Skipping build."
              echo "SHOULD_BUILD=0" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Clear older workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run list -L400 --json databaseId -q '.[].databaseId' | tail -n+10 | xargs -IID gh api "repos/$GITHUB_REPOSITORY/actions/runs/ID" -X DELETE || :

  cleanup:
    needs: check
    if: ${{ needs.check.outputs.SHOULD_BUILD == '1' }}
    uses: ./.github/workflows/delete-old-releases.yml
    secrets: inherit

  build:
    needs: [check, cleanup]
    if: ${{ needs.check.outputs.SHOULD_BUILD == '1' }}
    permissions: write-all
    uses: ./.github/workflows/build.yml
    secrets: inherit
